# SQL Agent 测试增强指南

**版本**: v5.2  
**更新日期**: 2025-07-04  
**目的**: 补充和增强test-guide-comprehensive.md中SQL Agent测试部分

## 概述

本文档是对主测试文档的补充，重点增强SQL Agent的18个模板测试用例，确保：
1. 每个模板都有完整的边界测试和错误测试
2. 特别覆盖v2.1.17新增的提取功能
3. 提供详细的测试验证标准

## 测试覆盖矩阵

| 模板编号 | 模板名称 | 正常用例 | 边界测试 | 错误测试 | v2.1.17相关 |
|---------|---------|---------|---------|---------|------------|
| 1.1 | 股价查询 | ✅ | ✅ | ✅ | ✅ |
| 1.2 | 成交量查询 | ✅ | ✅ | ✅ | ✅ |
| 1.3 | 估值指标 | ✅ | ✅ | ✅ | - |
| 1.4 | K线查询 | ✅ | ✅ | ✅ | ✅ |
| 1.5 | 涨跌幅排名 | ✅ | ✅ | ✅ | ✅ |
| 1.6 | 市值排名 | ✅ | ✅ | ✅ | ✅ |
| 1.7 | 成交额排名 | ✅ | ✅ | ✅ | - |
| 1.8 | 成交量排名 | ✅ | ✅ | ✅ | - |
| 1.9 | 主力净流入排名 | ✅ | ✅ | ✅ | - |
| 1.10 | 个股主力资金 | ✅ | ✅ | ✅ | ✅ |
| 1.11 | 板块主力资金 | ✅ | ✅ | ✅ | - |
| 1.12 | 利润查询 | ✅ | ✅ | ✅ | - |
| 1.13-17 | 财务排名 | ✅ | ✅ | ✅ | ✅ |
| 1.18 | 公告查询 | ✅ | ✅ | ✅ | ✅ |

## v2.1.17 提取功能测试重点

### 1. 日期范围连接符测试

**测试目标**: 验证新增的"-"和"~"连接符支持

```python
# 测试用例
test_cases = [
    "贵州茅台2025-06-01至2025-06-30的K线",  # 中文"至"
    "贵州茅台2025-06-01到2025-06-30的K线",  # 中文"到"
    "贵州茅台2025-06-01-2025-06-30的K线",   # 英文"-"
    "贵州茅台2025/6/1~2025/6/30的K线",      # 波浪号"~"
]

# 预期结果
expected = {
    "start_date": "20250601",
    "end_date": "20250630",
    "stock": "贵州茅台"
}
```

### 2. 月份/年份转换测试

**测试目标**: 验证月份和年份自动转换为日期范围

```python
# 月份转换测试
month_tests = [
    ("万科A6月的K线", ("20250601", "20250630")),
    ("中国平安本月的K线", (current_month_start, current_month_end)),
    ("贵州茅台上个月的K线", (last_month_start, last_month_end)),
]

# 年份转换测试
year_tests = [
    ("中国平安2024年的K线", ("20240101", "20241231")),
    ("万科A今年的K线", ("20250101", "20251231")),
    ("贵州茅台去年的K线", ("20240101", "20241231")),
]

# 季度转换测试
quarter_tests = [
    ("宁德时代2025年第二季度的走势", ("20250401", "20250630")),
    ("比亚迪今年第一季度的K线", ("20250101", "20250331")),
    ("万科A去年第四季度的走势", ("20241001", "20241231")),
]
```

### 3. 股票名称智能清理测试

**测试目标**: 验证日期替换不影响股票名称提取

```python
# 问题场景测试
problematic_cases = [
    "万科A前天的成交量",      # "A前天"不应被误解为整体
    "中国平安昨天的成交额",    # "平安昨天"不应被误解
    "贵州茅台最近5天的成交量", # 日期替换后仍能正确提取股票
    "宁德时代今天的成交额",    # "时代今天"不应被误解
]

# 验证方法
def verify_stock_extraction(query, expected_stock):
    # 1. 执行日期智能解析
    processed = preprocess_with_date_intelligence(query)
    
    # 2. 提取股票（应从原始查询提取）
    extracted_stock = extract_stock_from_original(query)
    
    # 3. 验证
    assert extracted_stock == expected_stock
```

### 4. 中文数字识别测试

**测试目标**: 验证中文数字正确转换

```python
# 中文数字测试用例
chinese_number_tests = [
    ("涨幅前二十", 20),
    ("贵州茅台最近三十天的K线", 30),
    ("市值前一百", 100),
    ("成交量前五", 5),
    ("主力净流入前十五", 15),
]

# 边界测试
edge_cases = [
    ("前十", 10),          # 简化表达
    ("TOP二十", 20),       # 混合表达
    ("最大的三十只", 30),  # 描述性表达
]
```

## 错误测试验证标准

### 1. 股票验证错误

```python
# 错误类型和预期提示
error_cases = {
    "茅台最新股价": "请使用完整公司名称，如：贵州茅台",
    "平安最新股价": "存在多个匹配，请使用完整名称",
    "123456最新股价": "股票代码123456不存在",
    "600519.sh最新股价": "证券代码后缀大小写错误，应为.SH",
}
```

### 2. 日期验证错误

```python
# 日期错误测试
date_errors = {
    "贵州茅台2025-06-31的股价": "无效的日期：6月没有31日",
    "万科A2025-13-01的成交量": "无效的月份：13",
    "中国平安2099年的K线": "日期超出数据范围",
    "贵州茅台明天的股价": "不支持未来日期查询",
}
```

### 3. 路由冲突测试

```python
# 确保正确路由
routing_tests = [
    ("成交量排名", "VOLUME_RANKING"),      # 应路由到排名模板
    ("贵州茅台的成交量", "VOLUME_QUERY"),  # 应路由到查询模板
    ("PE排名", "PE_RANKING"),              # 应路由到排名模板
    ("中国平安的PE", "VALUATION_QUERY"),   # 应路由到查询模板
]
```

## 性能测试标准

### 快速路径性能要求

| 模板类型 | 目标响应时间 | 最大响应时间 |
|---------|------------|------------|
| 股价查询 | <0.05秒 | 0.1秒 |
| 成交量查询 | <0.05秒 | 0.1秒 |
| K线查询 | <0.1秒 | 0.5秒 |
| 排名查询 | <0.2秒 | 1.0秒 |
| 财务排名 | <1.0秒 | 2.0秒 |
| 公告查询 | <0.5秒 | 1.0秒 |

### 性能测试脚本示例

```python
import time
from agents.sql_agent import SQLAgent

def test_template_performance(queries, expected_time):
    sql_agent = SQLAgent()
    
    for query in queries:
        start = time.time()
        result = sql_agent.query(query)
        elapsed = time.time() - start
        
        assert result['success'], f"查询失败: {query}"
        assert elapsed < expected_time, f"响应时间超标: {elapsed}秒"
        
        print(f"✅ {query}: {elapsed:.3f}秒")
```

## 测试执行建议

### 1. 分组执行

```bash
# 基础功能测试
python test_sql_basic_templates.py

# v2.1.17新功能测试
python test_sql_extraction_enhancements.py

# 性能测试
python test_sql_performance.py

# 错误处理测试
python test_sql_error_handling.py
```

### 2. 测试报告格式

```
SQL Agent测试报告 - v5.2
========================
测试时间: 2025-07-04 15:00
测试环境: dev-react-frontend-v2

模板测试结果:
1.1 股价查询: 15/15 ✅ (平均响应: 0.045s)
1.2 成交量查询: 18/18 ✅ (平均响应: 0.052s)
1.4 K线查询: 25/25 ✅ (平均响应: 0.125s)
...

v2.1.17功能测试:
- 日期范围连接符: 12/12 ✅
- 月份/年份转换: 15/15 ✅
- 股票名称清理: 8/8 ✅
- 中文数字识别: 10/10 ✅

总计: 285/285 测试通过
```

### 3. 回归测试清单

- [ ] 所有18个模板的基础功能
- [ ] v2.1.17新增的提取功能
- [ ] 中文数字支持
- [ ] 错误提示准确性
- [ ] 路由判断准确性
- [ ] 性能指标达标

## 常见问题排查

### 1. 股票提取失败

```python
# 调试方法
def debug_stock_extraction(query):
    print(f"原始查询: {query}")
    
    # 步骤1: 日期预处理
    processed = sql_agent._preprocess_question(query)
    print(f"日期处理后: {processed}")
    
    # 步骤2: 参数提取
    params = sql_agent._extract_query_params(
        query,      # 使用原始查询
        template,
        {},
        processed   # 处理后的查询
    )
    print(f"提取的参数: {params}")
```

### 2. 日期范围提取失败

```python
# 调试日期范围提取
def debug_date_range(query):
    # 尝试不同的提取方法
    range1 = sql_agent._extract_date_range_from_query(query)
    range2 = sql_agent._extract_month_year_range(query)
    
    print(f"日期范围提取: {range1}")
    print(f"月份/年份提取: {range2}")
```

## 总结

本增强指南确保SQL Agent的所有18个模板都有：
1. 完整的测试用例覆盖
2. 特别关注v2.1.17的新功能
3. 明确的性能和错误验证标准
4. 实用的测试执行建议

配合主测试文档使用，可以全面验证SQL Agent的功能正确性和性能表现。