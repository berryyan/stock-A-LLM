# SQL Agent 模板参数提取矩阵

**版本**: v1.0  
**更新日期**: 2025-07-04  
**目的**: 明确每个SQL模板需要提取的参数模块，便于测试和验证

## 一、公共参数模块定义

### 1. 股票相关
- **个股提取** (requires_stock): 提取单个股票代码/名称
- **板块提取** (requires_sector): 提取板块名称（如"银行板块"）
- **多股票提取** (requires_multiple_stocks): 提取多个股票用于对比

### 2. 时间相关
- **单一日期提取** (requires_date): 提取特定日期（如"昨天"、"2025-06-27"）
- **日期范围提取** (requires_date_range): 提取起止日期（如"6月"、"2025-06-01至2025-06-30"）
- **相对时间提取** (requires_relative_time): 提取相对时间表达（如"最近N天"、"过去N个月"）
- **报告期提取** (requires_report_period): 提取财务报告期（如"2025Q1"、"2024年报"）

### 3. 数量相关
- **数量限制提取** (requires_limit): 提取返回数量（如"前10"、"TOP20"）
- **中文数字转换** (requires_chinese_number): 支持中文数字（如"前二十"）

### 4. 指标相关
- **资金类型提取** (requires_fund_type): 提取资金类型（主力、超大单、大单等）
- **财务指标提取** (requires_financial_metric): 提取财务指标类型（PE、PB、ROE等）
- **排序方向提取** (requires_sort_order): 提取最高/最低、涨/跌等排序方向

### 5. 过滤条件
- **ST股票过滤** (supports_exclude_st): 支持排除ST/*ST股票
- **交易所过滤** (supports_exchange_filter): 支持按交易所过滤（排除北交所等）
- **板块过滤** (supports_sector_filter): 支持按板块过滤

## 二、模板参数提取矩阵

| 模板编号 | 模板名称 | 个股 | 板块 | 单一日期 | 日期范围 | 相对时间 | 报告期 | 数量限制 | 中文数字 | 资金类型 | 财务指标 | 排序方向 | ST过滤 |
|---------|---------|------|------|---------|---------|---------|--------|---------|---------|---------|---------|---------|--------|
| 1.1 | 股价查询 | ✅ | ❌ | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 1.2 | 成交量查询 | ✅ | ❌ | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 1.3 | 估值指标查询 | ✅ | ❌ | ⭕ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ | ❌ | ❌ |
| 1.4 | K线查询 | ✅ | ❌ | ❌ | ✅ | ✅ | ❌ | ⭕ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 1.5 | 涨跌幅排名 | ❌ | ❌ | ⭕ | ❌ | ❌ | ❌ | ✅ | ✅ | ❌ | ❌ | ✅ | ✅ |
| 1.6 | 市值排名 | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ | ❌ | ❌ | ✅ | ✅ |
| 1.7 | 成交额排名 | ❌ | ❌ | ⭕ | ❌ | ❌ | ❌ | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ |
| 1.8 | 成交量排名 | ❌ | ❌ | ⭕ | ❌ | ❌ | ❌ | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ |
| 1.9 | 主力净流入排名 | ❌ | ❌ | ⭕ | ❌ | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ |
| 1.10 | 个股主力资金 | ✅ | ❌ | ⭕ | ❌ | ✅ | ❌ | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ |
| 1.11 | 板块主力资金 | ❌ | ✅ | ⭕ | ❌ | ✅ | ❌ | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ |
| 1.12 | 利润查询 | ✅ | ❌ | ❌ | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 1.13 | PE排名 | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ | ❌ | ❌ | ✅ | ✅ |
| 1.14 | PB排名 | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ | ❌ | ❌ | ✅ | ✅ |
| 1.15 | 净利润排名 | ❌ | ❌ | ❌ | ❌ | ❌ | ⭕ | ✅ | ✅ | ❌ | ❌ | ✅ | ✅ |
| 1.16 | 营收排名 | ❌ | ❌ | ❌ | ❌ | ❌ | ⭕ | ✅ | ✅ | ❌ | ❌ | ✅ | ✅ |
| 1.17 | ROE排名 | ❌ | ❌ | ❌ | ❌ | ❌ | ⭕ | ✅ | ✅ | ❌ | ❌ | ✅ | ✅ |
| 1.18 | 公告查询 | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ | ⭕ | ❌ | ❌ | ❌ | ❌ | ❌ |

**图例说明**：
- ✅ 必需参数
- ⭕ 可选参数
- ❌ 不需要

## 三、v2.1.17 新增提取功能测试重点

### 1. 日期范围连接符扩展
影响模板：1.4（K线查询）、1.18（公告查询）
```
测试用例：
- "贵州茅台2025-06-01至2025-06-30的K线"（中文"至"）
- "贵州茅台2025-06-01-2025-06-30的K线"（英文"-"）
- "贵州茅台2025/6/1~2025/6/30的K线"（波浪号"~"）
```

### 2. 月份/年份转日期范围
影响模板：1.4（K线查询）、1.18（公告查询）
```
测试用例：
- "万科A6月的K线"（月份→日期范围）
- "中国平安2024年的K线"（年份→日期范围）
- "宁德时代2025年第二季度的走势"（季度→日期范围）
```

### 3. 股票名称智能清理
影响所有需要个股提取的模板（1.1、1.2、1.3、1.4、1.10、1.12、1.18）
```
测试用例：
- "万科A前天的成交量"（避免"A前天"被误解）
- "中国平安昨天的股价"（避免"平安昨天"被误解）
```

### 4. 中文数字识别
影响所有需要数量限制的模板（1.4-1.9、1.13-1.17）
```
测试用例：
- "涨幅前二十"
- "市值前一百"
- "贵州茅台最近三十天的K线"
```

## 四、参数提取测试方法

### 1. 单元测试示例
```python
def test_stock_extraction():
    """测试个股提取功能"""
    test_cases = [
        ("贵州茅台最新股价", "贵州茅台"),
        ("600519.SH最新股价", "600519.SH"),
        ("万科A前天的成交量", "万科A"),  # v2.1.17重点
    ]
    
    for query, expected_stock in test_cases:
        result = extract_stock_parameter(query)
        assert result == expected_stock

def test_date_range_extraction():
    """测试日期范围提取功能"""
    test_cases = [
        ("贵州茅台6月的K线", ("20250601", "20250630")),
        ("万科A2024年的K线", ("20240101", "20241231")),
        ("中国平安2025-06-01至2025-06-30的K线", ("20250601", "20250630")),
    ]
    
    for query, expected_range in test_cases:
        result = extract_date_range_parameter(query)
        assert result == expected_range
```

### 2. 集成测试示例
```python
def test_template_parameter_extraction():
    """测试模板参数提取完整流程"""
    sql_agent = SQLAgent()
    
    # 测试K线查询模板（需要：个股、日期范围、数量限制）
    query = "贵州茅台最近二十天的K线"
    
    # 预期提取结果
    expected_params = {
        "stock": "贵州茅台",
        "date_range": (calculate_date_range("最近二十天")),
        "limit": 20,
    }
    
    # 执行提取
    result = sql_agent._extract_query_params(query, template, {}, processed_query)
    
    # 验证
    assert result["stock"] == expected_params["stock"]
    assert result["date_range"] == expected_params["date_range"]
    assert result["limit"] == expected_params["limit"]
```

## 五、错误处理测试

### 1. 必需参数缺失
```python
# 股价查询模板必需个股参数
error_queries = [
    "最新股价",  # 缺少股票
    "昨天的股价",  # 缺少股票
]

# 预期错误提示
expected_errors = [
    "请指定具体的股票名称或代码",
    "请指定具体的股票名称或代码",
]
```

### 2. 参数格式错误
```python
# 日期格式错误
date_errors = [
    "贵州茅台2025-13-01的股价",  # 无效月份
    "万科A2025-06-31的K线",  # 无效日期
]

# 股票格式错误
stock_errors = [
    "茅台最新股价",  # 简称
    "123456.SH最新股价",  # 不存在
]
```

## 六、性能测试标准

| 参数提取类型 | 目标时间 | 最大时间 |
|-------------|---------|---------|
| 个股提取 | <5ms | 10ms |
| 日期提取 | <10ms | 20ms |
| 日期范围提取 | <20ms | 50ms |
| 中文数字转换 | <5ms | 10ms |
| 完整参数提取 | <50ms | 100ms |

## 七、回归测试清单

- [ ] 所有18个模板的参数提取正确性
- [ ] v2.1.17新增功能不影响原有功能
- [ ] 错误提示信息准确性
- [ ] 参数提取性能达标
- [ ] 边界条件处理正确