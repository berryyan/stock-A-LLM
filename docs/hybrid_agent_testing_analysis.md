# Hybrid Agent 测试分析与改造方案

## 1. Hybrid Agent 的定位与作用

### 核心职责
Hybrid Agent 是系统的**总路由器**，负责：
1. **查询意图识别**：判断用户查询属于哪种类型
2. **智能路由分发**：将查询路由到合适的Agent
3. **复合查询处理**：支持同时调用多个Agent
4. **结果整合**：汇总不同Agent的结果并生成统一响应

### 架构位置
```
用户查询
    ↓
Hybrid Agent (路由层)
    ↓
┌─────┬─────┬──────┬──────┐
SQL   RAG   Fin.   Money  (执行层)
```

## 2. 为什么要测试 Hybrid Agent

### 2.1 验证路由准确性
- 确保查询被路由到正确的Agent
- 避免财务查询被路由到SQL Agent
- 避免股价查询被路由到RAG Agent

### 2.2 验证复合查询能力
- 测试"贵州茅台的股价和主要业务"这类需要多个Agent的查询
- 确保并行执行和结果整合正常

### 2.3 验证模块化改造效果
虽然Hybrid Agent本身逻辑没变，但它调用的Agent都已模块化：
- 确保与新的模块化Agent接口兼容
- 验证错误消息能正确传递
- 测试参数提取和验证的一致性

## 3. 测试方案设计

### 3.1 路由准确性测试（核心）

#### SQL路由测试
```python
# 应该路由到SQL的查询
sql_queries = [
    "贵州茅台的股价是多少",
    "今天涨幅前10的股票",
    "万科A的成交量",
    "银行板块的涨跌情况"
]
```

#### RAG路由测试
```python
# 应该路由到RAG的查询
rag_queries = [
    "贵州茅台的主要业务是什么",
    "万科最新的公告内容",
    "比亚迪的发展战略",
    "宁德时代的竞争优势"
]
```

#### Financial路由测试
```python
# 应该路由到Financial的查询
financial_queries = [
    "分析贵州茅台的财务健康度",
    "万科A的杜邦分析",
    "比亚迪的现金流质量",
    "宁德时代的盈利能力"
]
```

#### Money Flow路由测试
```python
# 应该路由到Money Flow的查询
money_flow_queries = [
    "贵州茅台的主力资金流向",
    "银行板块的资金流入情况",
    "分析万科A的资金流向",
    "主力资金净流入前10"
]
```

### 3.2 复合查询测试（重要）

```python
composite_queries = [
    "贵州茅台的股价和主要业务",           # SQL + RAG
    "万科A的财务状况和最新公告",          # Financial + RAG
    "比亚迪的股价走势和资金流向",         # SQL + Money Flow
    "分析宁德时代的财务健康度和主力资金"   # Financial + Money Flow
]
```

### 3.3 边界和错误测试

```python
error_queries = [
    "",                      # 空查询
    "茅台",                  # 股票简称
    "不知道查什么",          # 模糊查询
    "1234567890" * 100      # 超长查询
]
```

### 3.4 特殊路由覆盖测试

测试routing_config中的特殊规则：
- 触发词路由（"排行分析："、"查询公告："等）
- 模板覆盖路由
- 强制路由规则

## 4. 与公共模块的关系

### 4.1 不直接使用公共模块
Hybrid Agent本身**不直接使用**公共模块，它只负责路由。实际的参数提取、验证等工作由各个子Agent完成。

### 4.2 间接受益
由于所有子Agent都已使用公共模块，Hybrid Agent间接受益：
- 统一的错误格式
- 一致的参数验证
- 标准化的响应结构

### 4.3 需要验证的集成点
- 错误消息是否正确传递
- 子Agent的响应格式是否兼容
- 并行执行时的错误处理

## 5. 测试重点

### 5.1 功能正确性（60%）
- 路由准确率 > 95%
- 复合查询成功率 > 90%
- 错误处理正确率 100%

### 5.2 性能指标（20%）
- 路由决策时间 < 0.1秒
- 额外开销 < 总响应时间的5%

### 5.3 兼容性（20%）
- 与所有模块化Agent兼容
- 错误格式统一
- 响应结构一致

## 6. 预期问题

### 6.1 路由歧义
某些查询可能有多种合理的路由选择：
- "贵州茅台的表现如何" → SQL? Financial? Money Flow?
- "分析万科A" → 太宽泛，可能路由错误

### 6.2 复合查询识别
- 可能无法识别所有的复合查询
- 并行执行可能有性能问题

### 6.3 错误传递
- 子Agent的错误可能被包装多层
- 用户可能看不到真实的错误原因

## 7. 测试执行计划

### Phase 1: 基础路由测试（1-2小时）
- 测试各类查询的路由准确性
- 验证错误处理
- 检查响应格式

### Phase 2: 复合查询测试（1小时）
- 测试所有复合查询组合
- 验证并行执行
- 检查结果整合

### Phase 3: 边界测试（30分钟）
- 测试各种边界情况
- 验证错误处理
- 检查性能指标

### Phase 4: 回归测试（30分钟）
- 确保没有破坏现有功能
- 验证与前端的兼容性

## 8. 成功标准

1. **路由准确率 > 95%**
2. **复合查询成功率 > 90%**
3. **所有错误都有友好提示**
4. **性能开销 < 5%**
5. **与所有子Agent完全兼容**

## 9. 测试脚本设计

### 9.1 快速验证脚本
- 20个核心用例
- 5分钟完成
- 验证基本功能

### 9.2 全面测试脚本
- 80-100个用例
- 覆盖所有功能点
- 30-40分钟完成

### 9.3 性能测试脚本
- 测量路由开销
- 对比直接调用
- 生成性能报告