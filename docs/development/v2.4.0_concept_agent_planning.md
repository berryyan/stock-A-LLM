# Concept Agent v2.4.0 开发规划与分析

版本：v1.0  
创建时间：2025-07-16  
更新时间：2025-07-16

## 1. 开发背景

在v2.3.0完成5个核心Agent优化后，v2.4.0的重点是开发Concept Agent（概念股分析专家）。该Agent旨在提供基于事实依据的概念股智能发现和分析功能。

## 2. 数据源分析

### 2.1 当前数据库概念板块表结构

经过深入探索，确认了三个数据源的表结构：

#### 2.1.1 同花顺（THS）- 数据完整 ✅
- **概念指数表**: `tu_ths_index`
  - `ts_code`: 指数代码（如881281.TI）
  - `name`: 指数名称（如"固态电池"）
  - `count`: 成分个数
  - `type`: 指数类型（N-概念/I-行业等）
  - 记录数：1,720条

- **成分股表**: `tu_ths_member` ✅
  - `ts_code`: 指数代码（关联tu_ths_index.ts_code）
  - `con_code`: 股票代码（如000009.SZ）
  - `con_name`: 股票名称（如"中国宝安"）
  - 记录数：101,604条

#### 2.1.2 东财（DC）- 缺少成分股表 ❌
- **概念表**: `tu_dc_index`
  - `ts_code`: 概念代码（如BK0968.DC）
  - `name`: 概念名称（如"固态电池"）
  - `up_num`/`down_num`: 上涨/下跌家数
  - `leading`/`leading_code`: 领涨股票信息
  - 记录数：85,073条

- **成分股表**: **缺失**
  - 需要通过API补充：https://tushare.pro/document/2?doc_id=363

#### 2.1.3 开盘啦（KPL）- 通过theme关联 ⚠️
- **概念表**: `tu_kpl_concept`
  - `ts_code`: 题材代码（如000169.KP）
  - `name`: 题材名称（如"固态电池概念"）
  - `z_t_num`: 涨停数量
  - 记录数：50,433条

- **个股表**: `tu_kpl_list`
  - `ts_code`: 股票代码
  - `name`: 股票名称
  - `theme`: 板块主题（文本字段，如"固态电池、锂电池"）
  - 记录数：114,968条

- **题材成分表**: **缺失**
  - 需要通过API补充：https://tushare.pro/document/2?doc_id=351

### 2.2 需要补充的数据表

1. **东财板块成分股**（dc_member）
   - API接口：https://tushare.pro/document/2?doc_id=363
   - 字段：ts_code（板块代码）、stock_code（股票代码）等

2. **开盘啦题材成分股**（kpl_member）
   - API接口：https://tushare.pro/document/2?doc_id=351
   - 字段：板块代码、股票代码、股票名称等

## 3. Concept Agent设计方案

### 3.1 核心功能
- 概念识别：支持关键词、概念查询、新闻文本等多种输入
- 智能匹配：通过LLM扩展相关概念，提高查全率
- 多维评分：概念关联度(40%) + 资金流向(30%) + 技术形态(30%)
- 专业输出：生成包含详细评分和分析的投资报告

### 3.2 输入类型支持
1. **关键词输入**："充电宝"
2. **概念查询**："固态电池概念股有哪些？"
3. **新闻文本**：长段落政策新闻分析

### 3.3 评分系统设计

#### 3.3.1 概念关联度（40分）
- 板块成分股：10分（在tu_ths_member等表中）
- 板块率先涨停：10分（最近5天内前3个涨停）
- 财报提及：5分
- 互动平台提及：5分
- 公告提及：5分
- 板块活跃度：5分（板块涨幅排名前20%）

#### 3.3.2 资金流向（30分）
- 日周双净流入：10分
  - 日净流入：5分
  - 周净流入：5分
- 净流入占比排名：10分
  - 概念内前10%：10分
  - 概念内前30%：7分
  - 概念内前50%：5分
- 板块资金表现：5分
- 连续净流入：5分
  - 连续5天：5分
  - 连续3天：3分

#### 3.3.3 技术形态（30分）
- MACD状态：15分
  - MACD水上红柱（MACD>0 AND DIF>0）：10分
  - 板块内率先水上（最近2天）：5分
- 均线排列：15分
  - MA5>MA10：15分
  - 可选：MA5>MA10>MA20

### 3.4 技术架构

#### 3.4.1 复用公共模块
- `utils.parameter_extractor.ParameterExtractor` - 参数提取
- `utils.unified_stock_validator.UnifiedStockValidator` - 股票验证
- `utils.date_intelligence` - 日期处理
- `utils.agent_response.create_agent_response` - 统一响应
- `utils.error_handler.ErrorHandler` - 错误处理
- `utils.result_formatter.ResultFormatter` - 结果格式化

#### 3.4.2 新增概念专用模块
```
utils/concept/
├── concept_matcher.py       # 概念匹配器（LLM扩展）
├── scoring_config.py        # 评分配置（灵活配置）
├── concept_data_collector.py # 数据采集器
└── concept_scorer.py        # 评分计算器
```

### 3.5 数据更新机制
- 盘后更新：每天17:00开始
- 失败重试：半小时重试一次，共3次
- 交易日判断：使用Tushare trade_cal接口
- 技术指标缓存：21天数据

## 4. 测试用例

基于用户提供的三个测试案例：

1. **TC001 - 简单概念查询**
   - 输入："概念股分析：充电宝概念股有哪些？"
   - 类型：concept_query
   - 期望：返回充电宝相关概念股列表

2. **TC002 - 复杂概念查询**
   - 输入："概念股分析：固态电池概念相关板块有哪些个股现在可以重点关注？"
   - 类型：concept_query
   - 期望：返回固态电池概念股并进行评分排序

3. **TC003 - 新闻文本分析**
   - 输入：关于固态电池政策的长新闻文本
   - 类型：news
   - 期望：提取概念关键词并分析相关投资机会

## 5. 开发计划

### Phase 1: 数据补充（优先）
1. 补充东财成分股表（dc_member）
2. 补充开盘啦题材成分表（kpl_member）

### Phase 2: 基础框架（Day 1-2）
1. 创建Agent主体结构
2. 实现输入处理和LLM概念扩展
3. 建立缓存框架

### Phase 3: 数据采集（Day 3-4）
1. 实现多源概念数据采集
2. 技术指标采集（Tushare API）
3. 盘后更新机制

### Phase 4: 评分系统（Day 5-6）
1. 实现三维评分计算
2. 配置化管理
3. 批量优化

### Phase 5: 报告生成（Day 7）
1. LLM报告生成
2. 输出格式化

### Phase 6: 测试优化（Day 8-10）
1. 集成测试
2. 性能优化
3. 系统集成

## 6. 关键技术点

### 6.1 概念匹配策略
- 精确匹配：直接匹配概念名称
- 模糊匹配：LLM扩展相关概念
- 降级策略：LLM失败时使用关键词匹配

### 6.2 数据整合挑战
- 同花顺：完整的成分股数据
- 东财：需要补充成分股表
- 开盘啦：需要补充题材成分表，同时利用theme字段

### 6.3 性能优化
- 并行数据采集
- 三级缓存架构（内存+数据库+Redis）
- 批量处理优化

## 7. 风险与对策

### 7.1 数据完整性
- 风险：东财和开盘啦成分股数据缺失
- 对策：立即通过API补充数据表

### 7.2 LLM稳定性
- 风险：LLM响应不稳定或格式不一致
- 对策：严格的响应解析和降级策略

### 7.3 性能瓶颈
- 风险：大量股票评分计算耗时
- 对策：并行处理和缓存优化

## 8. 下一步行动

1. **立即行动**：补充东财和开盘啦的成分股表
2. **数据验证**：确认补充后的数据完整性
3. **开始开发**：按照Day 1任务清单开始基础框架搭建

---

文档版本：v1.0  
最后更新：2025-07-16 22:30