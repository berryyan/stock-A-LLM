# Concept Agent Day 5 - 证据系统实现

## 实施日期
2025-07-18

## 核心成果

### 1. 重大发现
- 发现当前评分系统与原始设计不符
  - 原设计：基于事实证据的4维度评分（软件收录40分、财报30分、互动平台20分、公告10分）
  - 当前实现：基于技术指标的3维度评分（概念关联40分、资金流向30分、技术形态30分）
- 用户确认："按照完整方案实现证据系统"

### 2. 证据系统实现

#### 2.1 EvidenceCollector类（新建）
- **文件**：`utils/concept/evidence_collector.py`
- **功能**：收集4种类型的事实证据
- **实现细节**：
  ```python
  def collect_evidence(self, ts_code: str, concepts: List[str], 
                      data_sources: List[str] = None) -> Dict[str, List[Dict]]:
      evidence = {
          'software': [],      # 软件收录证据
          'report': [],        # 财报证据
          'interaction': [],   # 互动平台证据
          'announcement': []   # 公告证据
      }
  ```

#### 2.2 ConceptScorerV2类（新建）
- **文件**：`utils/concept/concept_scorer_v2.py`
- **功能**：基于证据的评分系统
- **评分规则**：
  - 软件收录（40分）：同花顺15分、东财15分、开盘啦10分
  - 财报证据（30分）：年报15分、季报15分
  - 互动平台（20分）：董秘确认20分
  - 公告证据（10分）：临时公告10分

#### 2.3 四种证据收集实现

**软件收录证据**：
- 查询三大数据源（THS、DC、KPL）的成分股表
- 自动判断股票在哪些数据源中被收录

**互动平台证据**：
- 查询`tu_irm_qa_sh`和`tu_irm_qa_sz`表
- 使用概念关键词搜索问答内容
- 智能判断是否确认或否认概念

**财报证据**（通过RAG）：
- 调用RAGAgentModular搜索年报/季报内容
- 提取概念相关的业务描述

**公告证据**（通过RAG）：
- 调用RAGAgentModular搜索公告内容
- 提取概念相关的公告标题

### 3. 技术难点解决

#### 3.1 SQL参数传递问题
- **问题**：MySQLConnector需要命名参数而非位置参数
- **解决**：
  ```python
  # 错误写法
  results = db.execute_query(query, [ts_code, f'%{concept}%'])
  
  # 正确写法
  results = db.execute_query(query, {
      'ts_code': ts_code,
      'concept_pattern': f'%{concept}%'
  })
  ```

#### 3.2 互动平台数据结构
- 发现交易所分表：`tu_irm_qa_sh`（上交所）、`tu_irm_qa_sz`（深交所）
- 需要根据股票代码后缀判断查询哪个表

#### 3.3 循环依赖问题
- RAGAgent的延迟初始化避免循环导入

### 4. 测试结果

#### 4.1 宁德时代(300750.SZ)测试
```
测试概念: ['储能', '锂电池']
软件收录证据: 0条（未在测试数据源中）
互动平台证据: 2条
  - 董秘回复: 钠电池具有成本低、低温性能好的优势... (得分: 20)
  - 董秘回复: 公司积极布局回收业务... (得分: 20)
得分汇总:
  软件收录: 0/40
  互动平台: 20/20
  总分: 20/60（不含财报/公告）
```

#### 4.2 比亚迪(002594.SZ)测试
```
测试概念: ['新能源汽车', '电池']
互动平台证据: 2条
  - 董秘确认新能源汽车业务 (得分: 20)
  - 董秘否认电池业务 (否定证据)
```

### 5. 报告生成优化

#### 5.1 证据详情展示
- 在评分表格中增加4个维度的得分列
- 前5只股票显示详细证据列表
- 使用`format_evidence_report`生成格式化报告

#### 5.2 关联强度判定
- 80分以上：核心概念股
- 60-79分：重要概念股
- 40-59分：相关概念股
- 20-39分：边缘概念股
- 20分以下：无关股票

### 6. 集成到ConceptAgent

修改`agents/concept/concept_agent.py`：
- 使用ConceptScorerV2替代原有评分器
- 设置权重为纯证据评分：`weights={'evidence': 1.0, 'technical': 0.0, 'money_flow': 0.0}`
- 更新报告格式化逻辑

## 测试脚本

1. **test_sql_params.py** - SQL参数传递测试
2. **test_evidence_collector_only.py** - 证据收集器测试（不含RAG）
3. **test_evidence_basic.py** - 基础证据测试
4. **test_evidence_simple.py** - 简化证据系统测试
5. **test_evidence_system.py** - 完整证据系统测试

## 后续计划

### Day 6 计划
1. 完成RAG集成测试
2. 优化证据收集性能
3. 增加更多证据类型（如研报、新闻等）
4. 完善否定证据的处理逻辑
5. 实现证据权重动态调整

### 性能优化方向
1. 批量查询优化
2. 证据缓存机制
3. 并行收集多种证据
4. RAG查询优化

## 关键决策记录

1. **评分系统重构**：从技术指标评分改为事实证据评分
2. **RAG集成**：财报和公告证据通过RAG获取
3. **互动平台利用**：充分利用董秘问答数据
4. **扩展性设计**：为未来增加更多证据类型预留接口

## 代码质量保证

- 所有SQL查询使用参数化防止注入
- 完善的错误处理和日志记录
- 模块化设计便于测试和维护
- 丰富的测试用例覆盖各种场景