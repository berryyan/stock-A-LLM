# v2.2.5 到 v2.2.6 升级指南

**文档版本**: 1.0  
**更新日期**: 2025-07-09  
**适用版本**: v2.2.5 → v2.2.6

## 📋 升级概述

v2.2.6 是一个功能增强版本，主要改进了参数验证逻辑和查询准确性。升级过程简单，无需数据库迁移。

## 🔧 升级步骤

### 1. 备份当前版本
```bash
# 备份当前代码
cp -r stock_analysis_system stock_analysis_system_v2.2.5_backup

# 备份配置文件
cp .env .env.backup
```

### 2. 获取新版本代码
```bash
# 切换到项目目录
cd stock_analysis_system

# 拉取最新代码
git fetch origin
git checkout v2.2.6

# 或者如果在分支上
git pull origin dev-react-frontend-v2
```

### 3. 更新依赖（如需要）
```bash
# 激活虚拟环境
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 检查是否有新依赖
pip install -r requirements.txt
```

### 4. 重启服务
```bash
# 停止当前服务
# Ctrl+C 或使用进程管理工具

# 启动新版本
python -m uvicorn api.main:app --reload --host 0.0.0.0 --port 8000
```

## 📝 主要变更

### 新增文件
1. `utils/sector_name_mapper.py` - 板块名称映射模块
2. `test_remaining_issues.py` - 测试脚本（可选）

### 修改文件
1. `utils/parameter_extractor.py` - 优化参数提取逻辑
2. `utils/query_validator.py` - 增强验证规则
3. `utils/unified_stock_validator.py` - 改进股票识别
4. `agents/sql_agent_modular.py` - 集成板块映射

### 配置变更
- 无配置文件变更
- 无环境变量变更
- 无数据库结构变更

## ⚠️ 注意事项

### 行为变化
1. **个股排名查询**
   - 之前："贵州茅台涨幅排名"可能返回数据
   - 现在：返回错误"个股不能进行排名查询"

2. **数量限制**
   - 之前：可能接受0或超过999的数量
   - 现在：严格限制在1-999范围内

3. **板块查询**
   - 之前："房地产板块"可能查询失败
   - 现在：自动映射到"房地产开发"

### 兼容性
- ✅ API接口完全兼容
- ✅ 数据库查询兼容
- ✅ 前端无需修改

## 🔍 验证升级

### 功能测试
```python
# 测试个股排名验证
curl -X POST http://localhost:8000/query \
  -H "Content-Type: application/json" \
  -d '{"question": "贵州茅台涨幅排名"}'
# 期望：返回错误信息

# 测试板块查询
curl -X POST http://localhost:8000/query \
  -H "Content-Type: application/json" \
  -d '{"question": "房地产板块的主力资金"}'
# 期望：返回正确数据
```

### 健康检查
```bash
# API健康检查
curl http://localhost:8000/health

# 数据库连接检查
python scripts/utils/system_check.py
```

## 🔄 回滚方案

如需回滚到v2.2.5：

```bash
# 停止当前服务
# Ctrl+C

# 切换到备份版本
cd ..
mv stock_analysis_system stock_analysis_system_v2.2.6
mv stock_analysis_system_v2.2.5_backup stock_analysis_system

# 或使用Git
cd stock_analysis_system
git checkout v2.2.5

# 重启服务
python -m uvicorn api.main:app --reload --host 0.0.0.0 --port 8000
```

## 📞 支持

如遇到问题，请：
1. 查看错误日志：`logs/api.log`
2. 检查系统状态：`python scripts/utils/system_check.py`
3. 参考测试报告：`docs/testing/v2.2.6-test-report.md`

---

**升级难度**: ⭐☆☆☆☆ (非常简单)  
**预计时间**: 5-10分钟  
**风险等级**: 低