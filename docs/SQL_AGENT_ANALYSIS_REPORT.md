# SQL Agent模板实现问题分析报告

**版本**: v2.1.3  
**日期**: 2025-06-30  
**目的**: 分析SQL Agent模板测试反馈问题，制定修复计划

## 一、测试结果汇总

### 通过测试的模板
1. **股价查询模板** ✅ - 快速路由正常，输出符合预期
2. **成交量查询模板** ✅ - 快速路由正常，正向测试符合预期

### 存在问题的模板
1. **K线查询模板** ❌ - 未能启用快速路由
2. **利润查询模板** ⚠️ - 存在SQL注入风险
3. **估值指标查询模板** ❌ - 未能启用快速路由
4. **涨跌幅排名模板** ⚠️ - 快速路由正常但未识别数量限制
5. **市值排名模板** ❌ - 未能匹配快速路由
6. **主力净流入排名模板** ❌ - 未能匹配快速路由
7. **成交额排名模板** ❌ - 未能匹配快速路由
8. **板块股票查询模板** ❌ - 功能完全失效

## 二、问题根因分析

### 1. K线查询未触发快速路由
**原因**: 模板名称不匹配
- `query_templates.py`中定义的是"K线查询"
- `sql_agent.py`中判断的是"K线查询"（匹配）
- 但可能被其他条件阻止了

**具体问题**:
```python
# utils/query_templates.py 第66行
pattern=r"(.+?)(?:的)?(?:从(.+?)到(.+?)|最近(\d+)天|过去(\d+)天|最近(\d+)个月|过去(\d+)个月)?的?(?:K线|走势)"
```
正则表达式过于复杂，可能无法正确匹配某些查询格式。

### 2. 利润查询SQL注入风险 🔴
**严重问题**: 直接输出了SQL语句
```
查询：601318.SH的净利润
回复：...建议查询最近5个报告期的数据，查询语句为：SELECT end_date, profit_dedt, netprofit_yoy FROM tu_fina_indicator WHERE ts_code='601318.SH' ORDER BY end_date DESC LIMIT 5
```

**风险分析**:
- LLM生成的SQL语句直接暴露给用户
- 用户可能通过构造特殊输入诱导LLM生成恶意SQL
- 需要严格过滤LLM输出，禁止返回SQL语句

### 3. 估值指标未触发快速路由
**原因**: 代码逻辑问题
- 模板定义正确
- 快速路由代码存在（第207-238行）
- 可能是参数提取失败或其他条件判断问题

### 4. 涨跌幅排名未识别数量限制
**原因**: 参数提取逻辑问题
```python
# utils/query_templates.py 第329-333行
numbers = re.findall(r'\d+', query)
if numbers and template.type == TemplateType.RANKING:
    params['limit'] = int(numbers[0])
```

**问题**:
- 只提取第一个数字，可能是日期而非数量
- 没有处理"前十"等中文数字
- 正则表达式中的分组未被正确使用

### 5. 市值排名等未触发快速路由
**原因**: 模板名称判断问题
```python
# sql_agent.py 第240行
elif template.name in ['涨跌幅排名', '总市值排名', '流通市值排名']:
```
代码中有判断，但可能被其他条件阻止。

### 6. 板块查询功能失效
**原因**: 
- 没有实现板块查询的快速路径
- 股票验证器拦截了查询
- 缺少板块相关的数据表或字段

### 7. 前端表格显示问题
**可能原因**:
- 后端输出的Markdown格式不正确
- 前端MarkdownRenderer组件未正确处理表格
- 需要检查实际输出格式

## 三、设计原则缺陷总结

### 1. 缺乏统一的查询处理流程
- 每个模板的处理逻辑分散
- 参数提取不一致
- 没有统一的错误处理

### 2. 正则表达式设计问题
- 过于复杂，难以维护
- 分组提取不合理
- 没有考虑中文数字

### 3. 安全性考虑不足
- LLM输出未经过滤
- SQL语句直接暴露
- 缺少输出安全检查

### 4. 模板设计不完整
- 缺少板块相关数据支持
- 输出格式不统一
- 错误提示不友好

## 四、修复计划

### Phase 1: 紧急修复（优先级最高）
1. **SQL注入风险修复** 🔴
   - 添加LLM输出过滤器
   - 禁止返回SQL语句
   - 实现安全检查机制

2. **涨跌幅排名数量限制修复**
   - 改进参数提取逻辑
   - 支持中文数字识别
   - 正确使用正则分组

### Phase 2: 快速路由修复
1. **修复未触发快速路由的模板**
   - K线查询
   - 估值指标
   - 市值排名
   - 主力净流入
   - 成交额排名

2. **统一查询处理流程**
   - 抽取公共方法
   - 规范参数提取
   - 统一错误处理

### Phase 3: 功能完善
1. **板块查询功能实现**
   - 设计板块数据结构
   - 实现板块查询逻辑
   - 添加行业分类支持

2. **输出格式优化**
   - 统一Markdown表格格式
   - 确保前端正确显示
   - 添加CSV导出支持

## 五、SQL Agent模板设计规范（建议）

### 1. 模板定义规范
```python
@dataclass
class TemplateDesign:
    # 基础信息
    name: str                    # 模板名称
    description: str             # 功能描述
    
    # 查询匹配
    patterns: List[str]          # 多个匹配模式
    priority: int                # 优先级（解决冲突）
    
    # 参数提取
    param_extractors: Dict       # 参数提取器
    validators: Dict             # 参数验证器
    
    # 路由配置
    route_type: str              # 路由类型
    enable_quick_path: bool      # 是否启用快速路径
    
    # SQL配置
    sql_template: str            # SQL模板
    sql_params: List[str]        # SQL参数列表
    
    # 输出配置
    output_format: str           # 输出格式（text/table/chart）
    formatter: Callable          # 格式化函数
    
    # 测试用例
    test_cases: Dict             # 正向和错误测试用例
```

### 2. 统一处理流程
```
1. 查询预处理
   - 日期智能解析
   - 股票名称标准化
   - 中文数字转换

2. 模板匹配
   - 按优先级匹配
   - 支持多模式匹配
   - 冲突解决机制

3. 参数提取
   - 统一提取器接口
   - 参数验证
   - 默认值处理

4. 查询执行
   - 快速路径判断
   - SQL参数绑定
   - 结果获取

5. 结果格式化
   - 格式选择
   - 数据转换
   - 安全过滤

6. 错误处理
   - 统一错误码
   - 友好提示
   - 日志记录
```

### 3. 安全规范
- 所有LLM输出必须经过安全过滤
- 禁止直接返回SQL语句
- 参数化查询防止SQL注入
- 敏感信息脱敏处理

### 4. 测试规范
- 每个模板必须有完整测试用例
- 包含边界条件测试
- 性能基准测试
- 回归测试自动化

## 六、后续Agent开发建议

基于SQL Agent的经验教训，建议：

1. **先设计后实现**
   - 完整的模板设计文档
   - 测试用例先行
   - 接口规范统一

2. **模块化开发**
   - 公共功能抽取
   - 组件复用
   - 接口标准化

3. **安全第一**
   - 输入验证
   - 输出过滤
   - 权限控制

4. **持续测试**
   - 单元测试
   - 集成测试
   - 性能测试

## 七、立即行动项

1. **创建SQL注入防护任务** 🔴
2. **修复涨跌幅排名数量识别**
3. **调查快速路由失效原因**
4. **制定统一的模板设计规范**
5. **更新项目文档和TODO列表**