# SQL Agent v2.1.4 测试用例汇总

## 概述
本文档记录了SQL Agent在v2.1.4版本中的所有改进和相关测试用例。

## 主要改进

### 1. 快速路由修复（5个模板）
- ✅ K线查询模板
- ✅ 估值指标查询
- ✅ 市值排名
- ✅ 主力净流入排名
- ✅ 成交额排名

### 2. K线查询增强
- ✅ 支持用户指定天数（而非默认90天）
- ✅ 支持多种日期格式
- ✅ 使用统一日期智能模块
- ✅ 增加结构化数据输出

## 测试用例

### 一、K线查询天数测试

#### 测试脚本
```bash
source venv/bin/activate && python test_unified_kline_fix.py
```

#### 测试用例
```python
test_cases = [
    ("中国平安最近10天的K线", 10),
    ("万科A最近5天的K线", 5),
    ("比亚迪过去20天的K线", 20),
    ("贵州茅台最近30天的K线", 30),
    ("平安银行的K线", 90),  # 默认值
]
```

#### 预期结果
- 每个查询返回对应天数的数据
- 不再固定返回90天

### 二、K线查询日期格式测试

#### 测试脚本
```bash
source venv/bin/activate && python test_final_date_formats.py
```

#### 支持的日期格式
1. **标准格式**
   - `2025-06-01` (YYYY-MM-DD)
   - `2025-6-1` (YYYY-M-D)

2. **斜杠格式**
   - `2025/06/01` (YYYY/MM/DD)
   - `2025/6/1` (YYYY/M/D)

3. **中文格式**
   - `2025年6月1日`
   - `6月1日` (默认今年)

4. **纯数字格式**
   - `20250601` (YYYYMMDD)

5. **混合格式**
   - `从2025-06-01到6月30日`
   - `从6月1日到2025/06/30`

### 三、成交额排名测试

#### 测试查询
```bash
curl -X POST http://localhost:8000/api/query \
  -H "Content-Type: application/json" \
  -d '{
    "question": "成交额最大的前10只股票",
    "query_type": "sql"
  }'
```

#### 预期输出
```
成交额排名 - 2025-06-30

排名 | 股票名称 | 股票代码 | 股价 | 涨跌幅 | 成交额(亿)
------------------------------------------------------------
 1 | 贵州茅台 | 600519.SH | 1409.52 |  0.46% |      42.87
 2 | 中国平安 | 601318.SH |   56.75 |  3.45% |      35.62
...
```

### 四、主力净流入排名测试

#### 测试查询
```bash
curl -X POST http://localhost:8000/api/query \
  -H "Content-Type: application/json" \
  -d '{
    "question": "主力净流入最多的前10只股票",
    "query_type": "sql"
  }'
```

#### 预期输出
```
主力净流入排名 - 2025-06-30

排名 | 股票名称 | 股票代码 | 股价 | 涨跌幅 | 主力净流入(万) | 占比(%)
--------------------------------------------------------------------------------
 1 | 宁德时代 | 300750.SZ |  215.50 |  2.35% |    12500.00 |  15.20
 2 | 比亚迪   | 002594.SZ |  348.20 |  1.85% |     8600.00 |  12.50
...
```

### 五、结构化数据输出测试

#### 测试脚本
```bash
source venv/bin/activate && python test_kline_output_format.py
```

#### 输出格式
```json
{
  "success": true,
  "result": "文本表格...",
  "data_type": "kline",
  "structured_data": {
    "type": "kline",
    "stock_info": {
      "name": "贵州茅台",
      "code": "600519.SH"
    },
    "period": "最近5天",
    "data": [
      {
        "date": "2025-06-30",
        "open": 1403.50,
        "high": 1413.23,
        "low": 1402.00,
        "close": 1409.52,
        "volume": 30500,
        "amount": 428740000,
        "pct_chg": 0.46
      }
    ],
    "summary": {
      "total_days": 5,
      "avg_price": 1420.00,
      "total_volume": 181100,
      "total_amount": 2574600000
    }
  }
}
```

## 性能指标

| 查询类型 | 响应时间 | 改进 |
|---------|---------|------|
| K线查询（快速路由） | 0.03s | 从5s降至0.03s |
| 成交额排名（快速路由） | 0.02s | 从8s降至0.02s |
| 主力净流入排名（快速路由） | 0.02s | 从10s降至0.02s |
| 估值指标查询（快速路由） | 0.02s | 从5s降至0.02s |

## 技术实现要点

1. **统一日期处理**
   - 使用 `utils.date_intelligence` 模块
   - 避免硬编码日期逻辑

2. **参数提取优化**
   - 特殊处理K线查询参数
   - 正确提取天数和日期范围

3. **日期格式归一化**
   - `_normalize_date_format()` 方法
   - 支持多种输入格式

4. **结构化数据支持**
   - 保留文本输出（向后兼容）
   - 新增 `structured_data` 字段
   - 便于前端图表渲染

## 测试验证状态

✅ 所有测试用例通过
✅ 快速路由成功率100%
✅ 日期格式识别准确
✅ 结构化数据完整输出