# Hybrid Agent 测试说明

## 测试脚本概述

本目录包含3个Hybrid Agent的测试脚本：

1. **test_hybrid_agent_quick_verify.py** - 快速验证脚本（推荐先运行）
   - 13个核心测试用例
   - 验证各种路由类型
   - 测试复合查询功能
   - 预计5分钟完成

2. **test_hybrid_composite_debug.py** - 复合查询调试脚本
   - 专门调试复合查询功能
   - 分析查询是否被正确识别
   - 检查结果是否包含多种信息

3. **test_hybrid_agent_comprehensive.py** - 综合测试脚本
   - 69个完整测试用例
   - 8大功能类别测试
   - 深度覆盖各种场景
   - 预计30-40分钟完成

## Hybrid Agent 的作用

Hybrid Agent是系统的**总路由器**，负责：
- **查询意图识别**：判断用户查询属于哪种类型
- **智能路由分发**：将查询路由到合适的Agent
- **复合查询处理**：支持同时调用多个Agent
- **结果整合**：汇总不同Agent的结果

## 测试重点

### 1. 路由准确性（最重要）
确保查询被路由到正确的Agent：
- 股价查询 → SQL Agent
- 公司业务 → RAG Agent
- 财务分析 → Financial Agent
- 资金流向 → Money Flow Agent

### 2. 复合查询能力
测试需要多个Agent协作的查询：
- "股价和主要业务" → SQL + RAG
- "财务状况和资金流向" → Financial + Money Flow

### 3. 错误处理
验证各种错误情况的处理：
- 空查询
- 股票简称（应该报错）
- 模糊查询

## 运行方法

### 1. 快速验证（推荐先运行）
```bash
# Windows环境
python test_hybrid_agent_quick_verify.py

# 预计时间：5分钟
# 用途：快速验证核心路由功能
```

### 2. 综合测试
```bash
# Windows环境
python test_hybrid_agent_comprehensive.py

# 预计时间：30-40分钟
# 用途：全面测试所有功能
```

## 测试用例分类（综合测试）

1. **智能路由功能** - 测试各类查询的路由准确性
2. **复合查询功能** - 测试多Agent协作场景
3. **投资价值分析** - 测试综合分析能力
4. **风险评估分析** - 测试风险相关查询
5. **综合对比分析** - 测试对比功能
6. **错误传递功能** - 测试错误处理机制
7. **特殊场景处理** - 测试边界情况
8. **并行查询功能** - 测试并发处理

## 测试结果分析（最新）

### 快速验证结果
- **总体通过率**: 76.9% (10/13)
- **路由准确率**: 单一路由100%准确
- **失败项**:
  1. "万科最新的公告内容" → 已修复为"万科A最新的公告内容"
  2. 复合查询识别问题（2个）

### 复合查询问题
当前复合查询被识别但没有正确执行并行查询，而是只路由到了其中一个Agent。这可能是设计限制或实现问题。

## 预期结果

### 快速验证（修正后）
- 路由准确率 > 90%
- 单一路由100%准确
- 复合查询可能需要特殊处理

### 综合测试
- 总体通过率 > 85%
- 路由准确率 > 95%
- 复合查询成功率 > 90%

## 已知限制

1. **路由歧义**：某些查询可能有多种合理的路由选择
   - 例如："贵州茅台表现如何" 可能路由到SQL、Financial或Money Flow

2. **复合查询识别**：不是所有包含"和"、"以及"的查询都是复合查询

3. **错误层级**：子Agent的错误可能被包装，需要解析才能看到真实错误

## 注意事项

1. **依赖所有Agent**：确保SQL、RAG、Financial、Money Flow Agent都正常工作
2. **网络连接**：需要访问数据库和LLM API
3. **响应时间**：复合查询可能需要较长时间（20-40秒）

## 测试目标

- **路由准确率 > 95%**：绝大多数查询路由正确
- **复合查询成功率 > 90%**：正确识别并处理复合查询
- **错误处理 100%**：所有错误都有友好提示
- **性能开销 < 5%**：路由决策的额外开销很小

## 调试技巧

如果测试失败，检查：
1. 查看实际路由类型（在快速验证脚本中有detect_actual_route函数）
2. 检查子Agent是否正常工作
3. 查看详细的错误信息
4. 检查routing_config.py中的路由规则