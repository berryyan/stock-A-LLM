<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨åˆ†ææ™ºèƒ½åŠ©æ‰‹ v1.4.2</title>
    
    <!-- ä¼˜å…ˆåŠ è½½æ ¸å¿ƒ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼‚æ­¥åŠ è½½å…¶ä»–èµ„æºï¼Œé¿å…é˜»å¡é¡µé¢æ¸²æŸ“ -->
    <script>
        // å¼‚æ­¥åŠ è½½èµ„æºçš„å‡½æ•°
        function loadScript(src, callback) {
            const script = document.createElement('script');
            script.src = src;
            script.async = true;
            script.onload = callback;
            script.onerror = () => console.warn('Failed to load:', src);
            document.head.appendChild(script);
        }

        function loadCSS(href) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href;
            link.onerror = () => console.warn('Failed to load CSS:', href);
            document.head.appendChild(link);
        }

        // é¡µé¢åŠ è½½åå¼‚æ­¥åŠ è½½éå…³é”®èµ„æº
        window.addEventListener('DOMContentLoaded', function() {
            // å¼‚æ­¥åŠ è½½ marked.js
            loadScript('https://cdn.jsdelivr.net/npm/marked/marked.min.js', function() {
                console.log('âœ… Marked.js loaded');
                initializeMarkdown();
            });

            // å¼‚æ­¥åŠ è½½ Chart.jsï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
            setTimeout(() => {
                loadScript('https://cdn.jsdelivr.net/npm/chart.js', function() {
                    console.log('âœ… Chart.js loaded');
                });
            }, 1000);

            // å¼‚æ­¥åŠ è½½ Prism.jsï¼ˆä»£ç é«˜äº®ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼‰
            setTimeout(() => {
                loadCSS('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css');
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js', function() {
                    loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js');
                    console.log('âœ… Prism.js loaded');
                });
            }, 2000);
        });

        // åˆå§‹åŒ–Markdowné…ç½®
        function initializeMarkdown() {
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    sanitize: false,
                    smartLists: true,
                    smartypants: false
                });
                
                // æ›´æ–°åŠ è½½çŠ¶æ€
                updateLoadingStatus();
            }
        }

        // æ›´æ–°åŠ è½½çŠ¶æ€
        function updateLoadingStatus() {
            const status = document.getElementById('loadingStatus');
            if (status) {
                status.innerHTML = `
                    <div class="flex items-center justify-center space-x-2">
                        <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                        <span>âœ… å¢å¼ºåŠŸèƒ½å·²å°±ç»ª</span>
                    </div>
                `;
                
                // 3ç§’åéšè—çŠ¶æ€æç¤º
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }
    </script>
    
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
        .chat-scroll {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }
        
        .chat-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-scroll::-webkit-scrollbar-track {
            background: #f7fafc;
        }
        
        .chat-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        
        .chat-scroll::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* æ‰“å­—åŠ¨ç”» */
        .typing-animation {
            display: inline-block;
        }
        
        .typing-dot {
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* æ¸å…¥åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ä»£ç å—æ ·å¼ */
        .message-content pre {
            background: #f8f9fa !important;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
        }
        
        .message-content code {
            background: #f1f5f9;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }
        
        .message-content th, .message-content td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
        }
        
        .message-content th {
            background-color: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="h-screen flex flex-col lg:flex-row">
        <!-- å·¦ä¾§å¯¹è¯åŒºåŸŸ (Claude.aié£æ ¼) -->
        <div class="flex-1 lg:w-3/5 flex flex-col bg-white">
            <!-- å¤´éƒ¨ -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 lg:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-bold flex items-center">
                            ğŸš€ è‚¡ç¥¨åˆ†ææ™ºèƒ½åŠ©æ‰‹ Enhanced
                        </h1>
                        <p class="text-blue-100 text-sm lg:text-base mt-1">
                            Claude.aié£æ ¼ç•Œé¢ â€¢ Tailwind CSS â€¢ v1.4.2 Enhanced
                        </p>
                    </div>
                    <div class="hidden lg:flex space-x-2">
                        <span class="px-3 py-1 bg-blue-500 bg-opacity-30 rounded-full text-xs">è´¢åŠ¡åˆ†æ</span>
                        <span class="px-3 py-1 bg-purple-500 bg-opacity-30 rounded-full text-xs">èµ„é‡‘æµå‘</span>
                        <span class="px-3 py-1 bg-indigo-500 bg-opacity-30 rounded-full text-xs">æ™ºèƒ½è§£æ</span>
                    </div>
                </div>
            </div>

            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div id="chatMessages" class="flex-1 p-4 lg:p-6 overflow-y-auto chat-scroll bg-gray-50">
                <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ -->
                <div class="flex items-start space-x-3 mb-6">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                        ğŸ¤–
                    </div>
                    <div class="flex-1 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div class="prose prose-sm max-w-none">
                            <p class="mb-3">æ‚¨å¥½ï¼æˆ‘æ˜¯è‚¡ç¥¨åˆ†ææ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ï¼š</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 my-4">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <div class="font-semibold text-blue-800 mb-1">ğŸ“Š è´¢åŠ¡åˆ†æ</div>
                                    <div class="text-blue-600 text-sm">è´¢åŠ¡å¥åº·åº¦è¯„åˆ†ã€æœé‚¦åˆ†æã€ç°é‡‘æµè´¨é‡åˆ†æ</div>
                                </div>
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                    <div class="font-semibold text-purple-800 mb-1">ğŸ’° èµ„é‡‘æµå‘</div>
                                    <div class="text-purple-600 text-sm">ä¸»åŠ›èµ„é‡‘ç›‘æ§ã€è¶…å¤§å•åˆ†æã€å››çº§èµ„é‡‘åˆ†å¸ƒ</div>
                                </div>
                                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                    <div class="font-semibold text-green-800 mb-1">ğŸ“ˆ æ™ºèƒ½è§£æ</div>
                                    <div class="text-green-600 text-sm">è‡ªç„¶è¯­è¨€æŸ¥è¯¢ã€æ—¶é—´æ™ºèƒ½è§£æã€æ•°æ®æ´å¯Ÿ</div>
                                </div>
                            </div>
                            
                            <p class="text-sm text-gray-600">è¯·è¾“å…¥æ‚¨æƒ³äº†è§£çš„è‚¡ç¥¨æˆ–åˆ†æéœ€æ±‚ï¼Œä¾‹å¦‚ï¼š</p>
                            <ul class="text-sm text-gray-700 mt-2 space-y-1">
                                <li>â€¢ "åˆ†æè´µå·èŒ…å°çš„è´¢åŠ¡å¥åº·åº¦"</li>
                                <li>â€¢ "èŒ…å°æœ€è¿‘çš„ä¸»åŠ›èµ„é‡‘æµå‘"</li>
                                <li>â€¢ "å¹³å®‰é“¶è¡Œå’Œæ‹›å•†é“¶è¡Œå¯¹æ¯”åˆ†æ"</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¿«æ·æ“ä½œåŒºåŸŸ -->
            <div class="p-4 bg-white border-t border-gray-200">
                <div class="flex flex-wrap gap-2 mb-3">
                    <button onclick="insertQuickMessage('åˆ†æè´µå·èŒ…å°çš„è´¢åŠ¡å¥åº·åº¦')" 
                            class="px-3 py-1.5 bg-gray-100 hover:bg-blue-100 hover:text-blue-700 rounded-lg text-sm transition-colors duration-200">
                        èŒ…å°è´¢åŠ¡åˆ†æ
                    </button>
                    <button onclick="insertQuickMessage('600519.SHæœ€è¿‘çš„èµ„é‡‘æµå‘')" 
                            class="px-3 py-1.5 bg-gray-100 hover:bg-purple-100 hover:text-purple-700 rounded-lg text-sm transition-colors duration-200">
                        èŒ…å°èµ„é‡‘æµå‘
                    </button>
                    <button onclick="insertQuickMessage('æ¯”è¾ƒè´µå·èŒ…å°å’Œäº”ç²®æ¶²çš„ç›ˆåˆ©èƒ½åŠ›')" 
                            class="px-3 py-1.5 bg-gray-100 hover:bg-green-100 hover:text-green-700 rounded-lg text-sm transition-colors duration-200">
                        ç™½é…’å¯¹æ¯”åˆ†æ
                    </button>
                    <button onclick="insertQuickMessage('Aè‚¡å¸‚å€¼æ’åå‰10')" 
                            class="px-3 py-1.5 bg-gray-100 hover:bg-indigo-100 hover:text-indigo-700 rounded-lg text-sm transition-colors duration-200">
                        å¸‚å€¼æ’è¡Œæ¦œ
                    </button>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="flex space-x-3">
                    <div class="flex-1 relative">
                        <input type="text" 
                               id="messageInput" 
                               placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all duration-200 disabled:bg-gray-100 disabled:text-gray-500 disabled:cursor-not-allowed">
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                            <button id="sendButton" 
                                    onclick="sendMessage()" 
                                    class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white rounded-full flex items-center justify-center transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§è¯¦æƒ…å±•ç¤ºåŒºåŸŸ (å¤§å±æ˜¾ç¤º) -->
        <div id="detailPanel" class="hidden lg:flex lg:w-2/5 bg-gray-50 border-l border-gray-200 flex-col">
            <div class="p-6 bg-white border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    åˆ†æè¯¦æƒ…
                </h2>
                <p class="text-sm text-gray-600 mt-1">è¯¦ç»†æ•°æ®å’Œå¯è§†åŒ–å›¾è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
            </div>
            
            <div id="detailContent" class="flex-1 p-6 overflow-y-auto chat-scroll">
                <div class="text-center text-gray-500 mt-20">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-lg font-medium">å¼€å§‹æ‚¨çš„åˆ†æ</p>
                    <p class="text-sm text-gray-400 mt-2">å‘é€é—®é¢˜åï¼Œè¯¦ç»†ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                    
                    <!-- èµ„æºåŠ è½½çŠ¶æ€ -->
                    <div id="loadingStatus" class="mt-4 text-xs text-gray-400">
                        <div class="flex items-center justify-center space-x-2">
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                            <span>æ­£åœ¨åŠ è½½å¢å¼ºåŠŸèƒ½...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let ws = null;
        let messageId = 0;
        let isSending = false;

        // Markdowné…ç½®å·²åœ¨å¼‚æ­¥åŠ è½½ä¸­å¤„ç†

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                showConnectionStatus('connected');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function(event) {
                console.log('WebSocketè¿æ¥å·²å…³é—­');
                showConnectionStatus('disconnected');
                setTimeout(initWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                showConnectionStatus('error');
            };
        }

        // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
        function showConnectionStatus(status) {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            hideTypingIndicator();
            setSendingState(false);
            
            if (data.type === 'analysis_result') {
                addMessage('assistant', data.content, data);
            } else if (data.type === 'error') {
                addMessage('assistant', `âŒ åˆ†æå‡ºé”™ï¼š${data.message}`);
            } else {
                addMessage('assistant', data.content || data.answer, data);
            }
        }

        // è®¾ç½®å‘é€çŠ¶æ€
        function setSendingState(sending) {
            isSending = sending;
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');
            
            sendButton.disabled = sending;
            messageInput.disabled = sending;
            
            if (sending) {
                messageInput.placeholder = 'æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...';
            } else {
                messageInput.placeholder = 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...';
                messageInput.focus();
            }

            // æ›´æ–°å¿«æ·æŒ‰é’®çŠ¶æ€
            const quickButtons = document.querySelectorAll('[onclick^="insertQuickMessage"]');
            quickButtons.forEach(button => {
                button.disabled = sending;
                if (sending) {
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            if (isSending) return;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            setSendingState(true);
            addMessage('user', message);
            input.value = '';
            
            showTypingIndicator();
            
            try {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'query',
                        message: message,
                        id: ++messageId
                    }));
                } else {
                    await sendHttpMessage(message);
                }
            } catch (error) {
                hideTypingIndicator();
                setSendingState(false);
                addMessage('assistant', `âŒ å‘é€å¤±è´¥ï¼š${error.message}`);
            }
        }

        // HTTP APIå‘é€æ¶ˆæ¯
        async function sendHttpMessage(message) {
            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                hideTypingIndicator();
                setSendingState(false);
                
                if (data.success) {
                    addMessage('assistant', data.answer, data);
                } else {
                    addMessage('assistant', `âŒ åˆ†æå¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                hideTypingIndicator();
                setSendingState(false);
                addMessage('assistant', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`);
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(sender, content, data = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start space-x-3 mb-6 fade-in ${sender === 'user' ? 'justify-end' : ''}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="max-w-xs lg:max-w-md bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg p-4 shadow-sm">
                        <div class="prose prose-sm prose-invert max-w-none">
                            ${escapeHtml(content)}
                        </div>
                    </div>
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 text-sm font-bold">
                        ğŸ‘¤
                    </div>
                `;
            } else {
                // å¤„ç†AIå›å¤çš„å†…å®¹æ ¼å¼åŒ–
                let processedContent = content || '';
                
                // é¦–å…ˆå¤„ç†æ¢è¡Œç¬¦
                if (typeof processedContent === 'string') {
                    processedContent = processedContent.replace(/\n/g, '\n\n');
                }
                
                // ä½¿ç”¨marked.jsæ¸²æŸ“Markdownï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä½¿ç”¨åŸºç¡€æ ¼å¼åŒ–
                let renderedContent;
                if (typeof marked !== 'undefined' && marked.parse) {
                    try {
                        renderedContent = marked.parse(processedContent);
                    } catch (e) {
                        console.warn('Marked.js parsing failed:', e);
                        renderedContent = formatTextBasic(processedContent);
                    }
                } else {
                    renderedContent = formatTextBasic(processedContent);
                }
                
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                        ğŸ¤–
                    </div>
                    <div class="flex-1 bg-white rounded-lg shadow-sm border border-gray-200 p-4 max-w-none">
                        <div class="message-content prose prose-sm max-w-none">
                            ${renderedContent}
                        </div>
                    </div>
                `;

                // å¦‚æœæœ‰æ•°æ®ï¼Œæ›´æ–°è¯¦æƒ…é¢æ¿
                if (data && window.innerWidth >= 1024) {
                    updateDetailPanel(data);
                }
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ›´æ–°è¯¦æƒ…é¢æ¿
        function updateDetailPanel(data) {
            const detailContent = document.getElementById('detailContent');
            
            let content = '<div class="space-y-6">';
            
            // æŸ¥è¯¢ä¿¡æ¯
            if (data.question) {
                content += `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800 mb-2">æŸ¥è¯¢å†…å®¹</h3>
                        <p class="text-blue-700">${escapeHtml(data.question)}</p>
                    </div>
                `;
            }

            // æŸ¥è¯¢ç±»å‹
            if (data.query_type) {
                const typeMap = {
                    'sql': { name: 'SQLæ•°æ®æŸ¥è¯¢', color: 'green' },
                    'rag': { name: 'RAGæ–‡æ¡£æ£€ç´¢', color: 'purple' },
                    'financial_analysis': { name: 'è´¢åŠ¡åˆ†æ', color: 'blue' },
                    'money_flow': { name: 'èµ„é‡‘æµå‘åˆ†æ', color: 'red' },
                    'hybrid': { name: 'æ··åˆæŸ¥è¯¢', color: 'indigo' }
                };
                
                const type = typeMap[data.query_type] || { name: data.query_type, color: 'gray' };
                content += `
                    <div class="bg-${type.color}-50 border border-${type.color}-200 rounded-lg p-4">
                        <h3 class="font-semibold text-${type.color}-800 mb-2">æŸ¥è¯¢ç±»å‹</h3>
                        <span class="inline-block bg-${type.color}-100 text-${type.color}-800 px-3 py-1 rounded-full text-sm font-medium">
                            ${type.name}
                        </span>
                    </div>
                `;
            }

            // è´¢åŠ¡åˆ†ææ•°æ®
            if (data.sources && data.sources.financial) {
                content += formatFinancialAnalysis(data.sources.financial);
            }

            // èµ„é‡‘æµå‘æ•°æ®
            if (data.money_flow_data) {
                content += formatMoneyFlowAnalysis(data.money_flow_data);
            }

            // å¤„ç†æ—¶é—´
            if (data.timestamp) {
                content += `
                    <div class="text-xs text-gray-500 border-t pt-4">
                        æŸ¥è¯¢æ—¶é—´: ${new Date(data.timestamp).toLocaleString('zh-CN')}
                    </div>
                `;
            }

            content += '</div>';
            detailContent.innerHTML = content;
        }

        // æ ¼å¼åŒ–è´¢åŠ¡åˆ†ææ•°æ®
        function formatFinancialAnalysis(financial) {
            let content = '';
            
            if (financial.health_score) {
                const score = financial.health_score;
                content += `
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">è´¢åŠ¡å¥åº·åº¦è¯„åˆ†</h3>
                        <div class="text-center mb-4">
                            <div class="text-3xl font-bold text-blue-600">${score.rating}</div>
                            <div class="text-gray-600">${score.total_score}åˆ†</div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>ç›ˆåˆ©èƒ½åŠ›</span>
                                <span class="font-medium">${score.dimension_scores.profitability}åˆ†</span>
                            </div>
                            <div class="flex justify-between">
                                <span>å¿å€ºèƒ½åŠ›</span>
                                <span class="font-medium">${score.dimension_scores.solvency}åˆ†</span>
                            </div>
                            <div class="flex justify-between">
                                <span>è¿è¥èƒ½åŠ›</span>
                                <span class="font-medium">${score.dimension_scores.operation}åˆ†</span>
                            </div>
                            <div class="flex justify-between">
                                <span>æˆé•¿èƒ½åŠ›</span>
                                <span class="font-medium">${score.dimension_scores.growth}åˆ†</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        // æ ¼å¼åŒ–èµ„é‡‘æµå‘æ•°æ®
        function formatMoneyFlowAnalysis(moneyFlow) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ èµ„é‡‘æµå‘æ•°æ®çš„æ ¼å¼åŒ–é€»è¾‘
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">èµ„é‡‘æµå‘åˆ†æ</h3>
                    <p class="text-gray-600 text-sm">è¯¦ç»†çš„èµ„é‡‘æµå‘æ•°æ®æ­£åœ¨å¤„ç†ä¸­...</p>
                </div>
            `;
        }

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex items-start space-x-3 mb-6 fade-in';
            
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                    ğŸ¤–
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <div class="typing-animation flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // æ’å…¥å¿«æ·æ¶ˆæ¯
        function insertQuickMessage(message) {
            if (isSending) return;
            
            const input = document.getElementById('messageInput');
            input.value = message;
            input.focus();
        }

        // åŸºç¡€æ–‡æœ¬æ ¼å¼åŒ–å‡½æ•° (ä½œä¸ºmarked.jsçš„åå¤‡)
        function formatTextBasic(text) {
            if (!text) return '';
            
            return text
                // è½¬æ¢æ¢è¡Œç¬¦
                .replace(/\n/g, '<br>')
                // åŠ ç²—
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // æ–œä½“
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // ä»£ç 
                .replace(/`(.*?)`/g, '<code style="background: #f1f5f9; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.9em;">$1</code>')
                // åˆ—è¡¨é¡¹
                .replace(/^- (.*$)/gim, '<div style="margin-left: 20px;">â€¢ $1</div>')
                // æ•°å­—åˆ—è¡¨
                .replace(/^(\d+)\. (.*$)/gim, '<div style="margin-left: 20px;"><strong>$1.</strong> $2</div>');
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && !isSending) {
                const input = document.getElementById('messageInput');
                if (document.activeElement === input) {
                    e.preventDefault();
                    sendMessage();
                }
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initWebSocket();
            } catch (error) {
                console.log('WebSocketä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨HTTP API');
            }
            
            // è®¾ç½®è¾“å…¥æ¡†ç„¦ç‚¹
            document.getElementById('messageInput').focus();
        });
    </script>
</body>
</html>