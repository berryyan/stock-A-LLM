# 版本发布说明 v2.1.18

**发布日期**: 2025-07-05  
**版本号**: v2.1.18  
**分支**: dev-react-frontend-v2  

## 🎯 版本概述

本版本主要修复了SQL Agent的边界测试问题，增强了股票代码和日期模式的识别能力，并统一了所有模板的股票提取方法，提升了系统的一致性和用户体验。

## 🐛 Bug修复

### 1. 股票代码无后缀识别问题
- **问题**: `extract_stock_entities` 方法不存在，导致程序崩溃
- **修复**: 正确使用 `extract_multiple_stocks` 方法
- **影响**: 现在支持 600519、000001、430047 等无后缀格式的股票代码

### 2. 日期模式识别不全
- **问题**: "上个交易日"、"前一个交易日"等常用表达无法识别
- **修复**: 在 `date_intelligence.py` 的 TIME_PATTERNS 中添加缺失模式
- **新增模式**:
  - "上个交易日"、"前一个交易日"、"最近一个交易日"、"最后一个交易日"
  - "前N个交易日"、"上N个交易日"（支持数字和中文数字）
  - 例如："前三个交易日"、"上5个交易日"

### 3. 日期替换空格问题
- **问题**: 日期替换时没有正确处理空格，导致 "600519最新股价" 变成 "6005192025-07-04股价"
- **修复**: 在 `replace_expressions_in_text` 方法中智能添加空格
- **效果**: 现在正确输出 "600519 2025-07-04股价"

### 4. 重复日期匹配问题
- **问题**: "前一个交易日" 被多个模式同时匹配，导致重复替换
- **修复**: 添加去重逻辑，确保每个位置只匹配一次
- **效果**: 避免了 "2025-07-037-03" 这样的错误输出

## ✨ 功能改进

### 股票提取方法统一化

#### 背景
之前不同的SQL模板使用不同的股票提取逻辑，导致：
- 维护困难
- 用户体验不一致
- 某些查询能识别复杂表达，而其他查询不能

#### 改进内容
1. **统一参数提取方法升级**：
   - 将 `UnifiedStockValidator` 集成到 `_extract_query_params` 方法
   - 实现两层提取策略：
     - 第一层：使用 UnifiedStockValidator 从处理后的查询提取
     - 第二层：失败时回退到原有的复杂逻辑

2. **所有模板享受相同能力**：
   - 股价查询、成交量查询、市盈率查询等所有模板现在具有相同的股票识别能力
   - 删除了各模板的特殊处理代码
   - 确保了系统的一致性

3. **遵循设计原则**：
   - 符合 Phase 1.3.1 的统一处理设计原则
   - 避免代码重复
   - 提高可维护性

## 📊 测试结果

- ✅ 股票代码无后缀测试：全部通过
- ✅ 日期模式识别测试：所有新增模式正常工作
- ✅ 复杂查询测试："贵州茅台前一个交易日的股价"等查询正常
- ✅ 模板一致性测试：所有模板的股票识别能力验证通过

## 📝 文档更新

- 更新 `CURRENT_STATUS.md` 至 v2.1.18
- 更新 `CLAUDE.md` 开发指南
- 更新 `test-guide-comprehensive.md` 至 v5.2 版本

## 🔄 升级指南

此版本为 bug 修复版本，无需特殊升级步骤：
1. 更新代码到最新版本
2. 重启 API 服务
3. 清理日期解析缓存（系统会自动处理）

## ⚠️ 注意事项

- 日期解析缓存会在系统启动时自动清理
- 股票代码映射缓存有 60 分钟 TTL，会自动更新

## 🚀 下一版本计划

v2.2.0 将专注于：
- SQL Agent 进一步优化
- 新增 3 个 Agent（Rank、ANNS、QA）
- 7-Agent 架构完整实现