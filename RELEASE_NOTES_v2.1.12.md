# 版本 v2.1.12 发布说明

**发布日期**: 2025-07-03  
**版本号**: v2.1.12  
**分支**: dev-react-frontend-v2

## 🔧 后端稳定性修复

### 1. 利润查询崩溃修复
- **问题**: 查询"贵州茅台利润"时因缺少period参数导致KeyError崩溃
- **修复**: 
  - 添加period参数默认值为1
  - 支持从查询中提取报告期信息
  - 增加异常处理保护
- **文件**: `utils/sql_templates.py` (execute_profit_query函数)

### 2. 净利润排名崩溃修复
- **问题**: 使用错误的net_profit字段导致数据库查询失败
- **原因**: 财务表中净利润字段实际为n_income，不是net_profit
- **修复**: 
  - 修正字段映射，使用正确的n_income字段
  - 更新SQL查询语句
- **文件**: `utils/sql_templates.py` (execute_profit_ranking函数)

### 3. RAG查询崩溃修复
- **问题**: limit参数传入字符串"10"导致Milvus查询失败
- **修复**: 
  - 确保limit参数转换为整数类型
  - 添加类型检查和转换
- **文件**: `agents/rag_agent.py` (_extract_documents方法)

## 💡 功能增强

### 1. 利润查询模板升级
- **新功能**: 支持指定报告期查询
- **示例**: "贵州茅台2025年一季度利润"
- **改进**:
  - 自动识别报告期："2025年一季度" → "20250331"
  - 报告期格式化显示："20250331" → "2025年一季度"
  - 默认查询最新报告期数据

### 2. 前端表格显示优化
- **问题**: Markdown表格在暗色模式下背景色过深
- **修复**: 
  - 统一表格样式
  - 确保暗色模式下的可读性
  - 优化表格边框和内边距
- **文件**: `frontend/src/components/common/MarkdownRenderer.tsx`

### 3. 资金查询格式优化
- **改进**:
  - 个股主力资金：返回单行精确数据
  - 板块主力资金：返回多行排名数据
  - 路由判断更准确，避免查询类型误判
- **文件**: `agents/sql_agent.py`, `utils/query_templates.py`

### 4. 营收排名模板增强
- **改进**: 扩展正则表达式，支持更多自然语言表达
- **支持**: "营业收入"、"营收"、"收入"等同义词
- **文件**: `utils/query_templates.py`

## 📚 文档更新

1. **CLAUDE.md**
   - 更新版本号至v2.1.12
   - 添加v2.1.12更新日志
   - 更新项目状态描述

2. **docs/project_status/CURRENT_STATUS.md**
   - 更新版本和状态信息
   - 添加详细的更新内容说明
   - 更新版本历史

3. **test-guide-comprehensive.md**
   - 更新至v4.7版本
   - 添加新功能测试用例
   - 更新错误处理测试场景

## 🧪 测试文件

新增的测试文件（未跟踪）：
- `test_beijing_exchange_data.py` - 北交所数据测试
- `test_financial_rankings.py` - 财务排名功能测试
- `test_revenue_ranking.py` - 营收排名测试

## 📊 影响评估

- **稳定性**: 显著提升，修复了3个导致后端崩溃的严重问题
- **用户体验**: 改善了错误处理和提示信息
- **功能性**: 增强了利润查询的灵活性
- **兼容性**: 保持向后兼容，不影响现有功能

## 🚀 部署建议

1. 更新后端代码
2. 重启API服务
3. 清理前端缓存
4. 测试所有修复的功能点

## ⚠️ 注意事项

- 财务数据字段映射已修正，确保使用n_income而非net_profit
- RAG查询的limit参数现在严格要求整数类型
- 利润查询现在支持更复杂的报告期指定方式

---

## Git提交命令

```bash
# 添加所有修改的文件
git add -A

# 提交更改
git commit -m "fix: 修复多个后端崩溃问题，增强利润查询和前端表格显示

- 修复利润查询缺少period参数导致的KeyError
- 修复净利润排名使用错误字段的问题
- 修复RAG查询limit参数类型错误
- 增强利润查询支持指定报告期
- 优化前端Markdown表格暗色模式显示
- 优化个股/板块主力资金查询格式
- 增强营收排名模板正则表达式
- 更新文档至v2.1.12"

# 推送到远程
git push origin dev-react-frontend-v2
```